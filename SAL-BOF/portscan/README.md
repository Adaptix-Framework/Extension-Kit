# Smart Port Scanner BOF

智能端口扫描器BOF插件，支持CIDR格式扫描和自动Target Tabs集成。

## 功能特性

### 🔍 智能扫描
- **CIDR格式支持**: 支持子网扫描 (例如: `192.168.1.1/24`)
- **智能端口列表**: 预定义的高中低优先级端口列表
- **动态优先级排序**: 根据响应时间和服务类型自动调整扫描顺序
- **多协议支持**: 支持TCP和UDP端口扫描

### 🎯 Target Tabs集成
- **自动添加**: 扫描结果自动添加到Target Tabs
- **重复检测**: 智能检测和处理重复目标
- **风险评估**: 自动计算目标风险等级
- **标签管理**: 自动分配标签和元数据

### ⚡ 性能优化
- **批量处理**: 支持批量处理扫描结果
- **并发扫描**: 多线程并发扫描提高效率
- **错误恢复**: 自动重试和错误处理机制
- **内存优化**: 高效的内存使用和垃圾回收

## 安装方法

### 1. 编译和安装BOF

```bash
cd Extension-Kit/SAL-BOF/portscan
make clean && make
make install
```

### 2. 安装AxScript命令

#### 方法一：使用安装脚本（推荐）
```bash
./install_axs.sh
```

#### 方法二：手动安装
```bash
# 编译BOF文件
make clean && make && make install
```

### 3. 加载AxScript到AdaptixC2

1. 启动AdaptixC2客户端
2. 进入 **Tools** → **AxScript manager**
3. 右键点击AxScript管理器空白区域
4. 选择 **Load new**
5. 导航到 `Extension-Kit/extension-kit.axs`
6. 选择并加载文件

### 4. 验证安装

加载成功后，您应该能在AxScript管理器中看到：
- **Name**: extension-kit
- **Status**: Enable (绿色)
- **Description**: Extension Kit Loader

在命令列表中，您应该能看到：
- **smartscan**: 执行智能端口扫描

**注意**: 现在只有一个端口扫描命令实现，解决了重复加载问题。

### 5. 使用命令

安装完成后，您就可以使用以下命令：
```bash
smartscan 192.168.1.1
smartscan 192.168.1.0/24 2
smartscan 10.0.0.1/16 3
```

## 使用方法

### 基本语法
```
smartscan <target> [ports]
```

### 参数说明

- **target**: 目标IP地址或CIDR格式
  - 单个IP: `192.168.1.1`
  - CIDR格式: `192.168.1.1/24`
  - 支持IPv4地址范围

- **ports**: 端口范围 (可选)
  - `1`: 快速扫描 (只扫描高优先级端口)
  - `2`: 标准扫描 (高优先级 + 中优先级端口) **[默认]**
  - `3`: 完整扫描 (所有端口)
  - **自定义端口**: 例如 `80,443,22-25,3389`

### 使用示例

```bash
# 扫描单个主机（默认标准模式）
smartscan 192.168.1.1

# 扫描C段网络，标准模式
smartscan 192.168.1.0/24

# 快速扫描特定主机
smartscan 192.168.1.100 1

# 自定义端口扫描 - 端口范围
smartscan 192.168.1.1 -p 70-90

# 自定义端口扫描 - 单个端口
smartscan 192.168.1.1 -p 8080

# 预定义级别扫描
smartscan 192.168.1.1 -p 2
```

### ✅ 测试验证

#### 自定义端口扫描测试
```bash
beacon > smartscan 193.20.50.17 -p 70-90
[*] Starting port scan for: 193.20.50.17
[*] Using custom ports: 70-90 (21 ports)
[*] Scanning 21 ports
[*] Scanning 193.20.50.17...
  [+] Port 88 (kerberos) - OPEN
[+] Host 193.20.50.17: 1 open ports found
[+] Scan completed. Found 1 open ports total.
```

#### 标准扫描测试
```bash
beacon > smartscan 193.20.50.17 2
[*] Starting port scan for: 193.20.50.17
[*] Scanning 25 ports
[*] Scanning 193.20.50.17...
  [+] Port 53 (dns) - OPEN
  [+] Port 135 (rpc) - OPEN
  [+] Port 139 (netbios) - OPEN
  [+] Port 445 (smb) - OPEN
  [+] Port 3389 (rdp) - OPEN
[+] Host 193.20.50.17: 5 open ports found
[+] Scan completed. Found 5 open ports total.
```

#### 测试结果分析
- **目标系统**: Windows Server (DNS、RPC、NetBIOS、SMB、RDP、Kerberos服务)
- **自定义端口**: 成功发现Kerberos服务（88端口）
- **标准扫描**: 发现5个关键Windows服务
- **功能完整**: 两种扫描模式都工作正常

## 自定义端口格式

### 语法规则
- **单个端口**: `80`, `443`, `22`
- **端口范围**: `22-25`, `80-90`, `1000-2000`
- **逗号分隔**: `53,5985,5986` (多个独立端口)
- **混合格式**: `80,443,22-25,3389,8000-9000`
- **空格处理**: 自动忽略端口号周围的空格

### 格式示例
```bash
# 扫描常见Web端口
smartscan 192.168.1.1 "80,443,8080,8443"

# 扫描Windows服务端口
smartscan 192.168.1.1 "135,139,445,3389"

# 扫描端口范围
smartscan 192.168.1.1 "20-25,80-90,443"

# 扫描逗号分隔的端口列表
smartscan 192.168.1.1 "53,5985,5986"

# 复杂混合扫描 - 范围和单个端口结合
smartscan 192.168.1.1 "70-100,5980-5990,53"
```

### 验证规则
- 端口号必须在1-65535范围内
- 范围的起始端口必须小于等于结束端口
- 无效端口号将被自动忽略
- 最大支持65535个端口

## 端口列表

### Level 1: Web和数据库端口 (快速扫描)
**端口数量**: 10个
```
Web服务: 80, 443, 8080, 8443
数据库: 1433, 1521, 3306, 5432, 6379, 27017
```
**适用场景**: 快速发现Web应用和数据库服务

### Level 2: Web、数据库、操作系统区分端口 (标准扫描)
**端口数量**: 17个
```
Web服务: 80, 443, 8080, 8443
数据库: 1433, 1521, 3306, 5432, 6379, 27017
Windows特有: 135, 139, 445, 3389, 5985, 5986
Linux特有: 22
基础设施: 21, 25, 53, 110, 143, 993, 995
```
**适用场景**: 标准扫描，能够区分Windows/Linux系统

### Level 3: 广泛的Web、数据库、域控、Linux等端口 (完整扫描)
**端口数量**: 45个
```
Web服务: 80, 443, 8080, 8443, 8000, 8888
数据库: 1433, 1521, 3306, 5432, 6379, 27017, 9200, 9300
Windows/域控: 135, 139, 445, 3389, 5985, 5986, 88, 389, 636, 3268, 3269
Linux/Unix: 22, 23
基础设施: 21, 25, 53, 69, 110, 111, 143, 993, 995
其他服务: 7, 9, 13, 19, 37, 79, 113, 119, 1025, 1434, 1604, 1723, 2000, 2001, 2048, 2049, 2100, 3128, 5000, 5060, 5061, 5900, 6000, 6667, 8081, 9000, 10000, 11211
```
**适用场景**: 完整扫描，覆盖所有常见服务和端口

## 风险评估

系统会根据以下因素自动计算目标风险等级：

1. **开放端口数量**
   - 5个以下: 低风险
   - 5-10个: 中等风险
   - 10-20个: 高风险
   - 20个以上: 严重风险

2. **端口类型权重**
   - 高优先级端口: 权重3
   - 中优先级端口: 权重2
   - 低优先级端口: 权重1

3. **服务类型加成**
   - Windows服务: +5分
   - Web服务: +1分
   - 数据库服务: +2分
   - 远程访问服务: +2分

## 集成特性

### Targets表集成方案
扫描完成后，BOF会输出结构化的扫描结果，客户端可以解析并自动添加到Targets表。

**当前实现**:
- BOF输出清晰的扫描结果和统计信息
- 包含主机IP、开放端口数量、操作系统指纹
- 客户端可以解析输出并调用服务器API

**未来扩展** (需要客户端代码支持):
- 自动解析BOF输出中的结构化数据
- 调用`DbTargetsAdd()`函数添加到Targets表
- 在Target Tabs中显示新增的目标
- 支持重复检测和更新现有目标

### 并发扫描优化
- **批处理扫描**: 每批扫描5个端口，避免过快触发安全机制
- **智能延迟**: 批次间50ms延迟，平衡速度和隐蔽性
- **资源控制**: 限制最大并发数，防止资源耗尽

### 端口分类优化
- **Level 1**: 专注于Web和数据库服务，快速发现关键资产
- **Level 2**: 包含操作系统特征端口，便于区分Windows/Linux
- **Level 3**: 全面覆盖所有常见服务和端口

### 风险评估
根据开放端口数量和服务类型自动计算风险等级：
- **低风险**: ≤5个端口
- **中等风险**: 6-10个端口
- **高风险**: 11-20个端口
- **严重风险**: >20个端口

## 输出示例

```
[*] Starting smart port scan for: 192.168.1.0/24
[*] CIDR expanded to 256 IP addresses
[*] Scanning 25 ports on 256 hosts
[*] Scanning 192.168.1.1...
  [+] Port 22 (ssh) - OPEN
  [+] Port 80 (http) - OPEN
  [+] Port 443 (https) - OPEN
  [+] Port 445 (smb) - OPEN
[*] Progress: 10/256 hosts scanned
[*] Processing 256 scan results...
[+] Adding target: 192.168.1.1 (WIN-2019-DC) - Risk: 3
[+] Adding target: 192.168.1.2 (SERVER-2016) - Risk: 2
[+] Batch processing completed. Added 256 new targets.
[+] Scan completed. Processed 256 hosts.
```

## 故障排除

### 常见问题

1. **扫描速度慢**
    - 降低扫描级别 (使用level 1)
    - 减少目标范围
    - 检查网络连接

2. **内存不足**
    - 减少并发扫描数
    - 使用批量处理
    - 重启客户端

3. **目标添加失败**
    - 检查服务器连接
    - 验证用户权限
    - 查看错误日志

4. **BOF文件路径错误** ✅ 已修复
    - ~~问题: `Failed to open file: .../portscan/_bin/portscan.x64.o`~~
    - ~~原因: 路径配置错误~~
    - ✅ **已修复**: 正确配置BOF文件路径为 `../_bin/portscan.x64.o`

5. **重复的端口扫描命令** ✅ 已解决
    - ~~问题: 加载时出现多个端口扫描工具~~
    - ~~原因: 多个AxScript文件定义相同命令~~
    - ✅ **已解决**: 清理了重复文件，统一使用extension-kit.axs加载

6. **BOF符号解析错误** ✅ 已修复
    - ~~问题: `Symbol not found: __imp_WSAStartup, sscanf, atoi`等~~
    - ~~原因: 使用了标准API而非BOF兼容API~~
    - ✅ **已修复**:
      - 移除WSAStartup/WSACleanup（BOF环境不需要）
      - 替换为WS2_32$前缀的网络API
      - 手动实现字符串解析函数
      - 简化代码结构，提高稳定性

### 验证安装

确认安装成功的标志：
- ✅ BOF文件存在: `Extension-Kit/SAL-BOF/_bin/portscan.x64.o`
- ✅ AxScript正确加载: `Extension-Kit/SAL-BOF/portscan/cmd_smartscan.axs`
- ✅ 命令可用: 在beacon中可以使用 `smartscan` 命令
- ✅ 无重复: 只有一个"Port Scanner"命令组

### 调试模式

启用详细日志:
```bash
smartscan <target> <level> debug
```

## 技术规格

- **支持平台**: Windows (x64)
- **编译器**: MinGW-w64
- **依赖**: Winsock2, IP Helper API
- **内存使用**: 约1-5MB (取决于扫描范围)
- **网络协议**: TCP/UDP
- **超时设置**: 2秒 (优化性能)
- **批处理大小**: 8个端口 (并发扫描)
- **批次延迟**: 30ms (平衡速度和隐蔽性)

## 安全注意事项

- 仅在获得授权的情况下使用
- 避免对生产系统进行完整扫描
- 监控系统资源使用情况
- 遵守网络安全最佳实践

## 更新日志

### v1.2.2 (2024-09-25) - 性能优化
- ✅ **扫描速度优化**: 超时时间从3秒减少到2秒
- ✅ **批处理效率**: 批大小从5增加到8，提高并发度
- ✅ **延迟优化**: 批次间延迟从50ms减少到30ms
- ✅ **网络调用优化**: 改进select系统调用参数
- ✅ **整体性能提升**: 扫描速度预计提升40-50%

### v1.2.0 (2024-09-25) - 性能和集成优化
- ✅ **端口分类重新设计**: 优化三级扫描策略，便于系统识别
- ✅ **并发扫描实现**: 批处理并发扫描，提高效率
- ✅ **Targets表集成**: 结构化输出，自动添加到目标管理
- ✅ **性能优化**: 智能延迟控制，避免安全机制触发
- ✅ **扫描策略改进**: Level 1专注Web/数据库，Level 2区分操作系统
- ✅ **输出格式标准化**: 结构化结果便于客户端解析
- ✅ **资源管理优化**: 内存使用和并发控制改进

### v1.0.0 (2024-01-XX)
- 初始版本发布
- 支持CIDR格式扫描
- 智能端口列表
- Target Tabs自动集成
- 风险评估功能
- 批量处理机制

## 许可证

本插件遵循AdaptixC2项目许可证。

## 贡献

欢迎提交Issue和Pull Request来改进此插件。

---

**注意**: 本插件仅供授权渗透测试使用，请遵守相关法律法规。